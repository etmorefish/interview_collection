# 18. å¦‚ä½•ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é™æµï¼Ÿåœ¨ Spring Cloud Gateway ä¸­ï¼Œæä¾›äº† Redis åˆ†å¸ƒå¼é™æµå™¨çš„å®ç°ï¼Œå…·ä½“ç›´æ¥çœ‹ [ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.10) ä¹‹ RequestRateLimiterGatewayFilterFactory è¯·æ±‚é™æµã€‹](http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/) çš„ [ã€Œ5.3 Redis Lua è„šæœ¬ã€](http://svip.iocoder.cn/Redis/Interview/#) éƒ¨åˆ†ã€‚

å¦å¤–ï¼ŒRedisson åº“ä¸­ï¼Œä¹Ÿæä¾›äº† Redis åˆ†å¸ƒå¼é™æµçš„å®ç°ï¼Œä¸è¿‡éœ€è¦ä½¿ç”¨ Pro ç‰ˆæœ¬ã€‚

ğŸ¦… **è¯·ç”¨ Redis å’Œä»»æ„è¯­è¨€å®ç°ä¸€æ®µæ¶æ„ç™»å½•ä¿æŠ¤çš„ä»£ç ï¼Œé™åˆ¶ 1 å°æ—¶å†…æ¯ç”¨æˆ· Id æœ€å¤šåªèƒ½ç™»å½• 5 æ¬¡ã€‚**

è¿™ä¸ªé—®é¢˜ï¼Œå…³é”®ç‚¹ï¼Œå°±æ˜¯æ¯ä¸ªç”¨æˆ·ï¼Œæ¯ 3600 ç§’ï¼Œåªèƒ½ç™»é™† 5 æ¬¡ã€‚è¿™ä¹ˆä¸€æƒ³ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¦‚ä½•ä½¿ç”¨ Redis å®ç°é™æµçš„é—®é¢˜ã€‚Redis å®ç°é™æµï¼Œä¸€å…±æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

- ä½¿ç”¨ zset å®ç°æ»‘åŠ¨çª—å£é™æµã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```go
  public boolean isActionAllowed(String userId, String actionKey, int period,
      int maxCount) {
      String key = String.format(""hist:%s:%s"", userId, actionKey); // ä½¿ç”¨ç”¨æˆ·ç¼–å· + è¡Œä¸ºä½œä¸º KEY ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»Ÿè®¡æŸä¸ªç”¨æˆ·çš„æ“ä½œè¡Œä¸ºã€‚
      long nowTs = System.currentTimeMillis(); // è·å–å½“å‰æ—¶é—´ã€‚
      Pipeline pipe = jedis.pipelined(); // pipeline æ‰¹é‡æ“ä½œï¼Œæå‡æ•ˆç‡ã€‚
      pipe.multi(); // æ­¤å¤„å¯åŠ¨äº†äº‹åŠ¡ï¼Œå¯ä»¥ä¿è¯æŒ‡ä»¤çš„åŸå­æ€§ã€‚
      pipe.zadd(key, nowTs, """" + nowTs); // zset æ·»åŠ ï¼Œkey value score è¦çœ‹ä¸‹ã€‚
      pipe.zremrangeByScore(key, 0, nowTs - (period * 1000)); // zremrangeByScore ï¼Œç§»é™¤è¶…è¿‡å‘¨æœŸçš„ value ã€‚
  
      Response<Long> count = pipe.zcard(key); // zcard ï¼Œè®¡ç®— zset çš„æ•°é‡
      pipe.expire(key, period + 1); // è®¾ç½®è¿‡æœŸã€‚è¿™é‡Œå¤š + 1 ç§’ï¼Œä¸ºäº†é˜²æ­¢ç½‘ç»œå»¶è¿Ÿã€‚
      pipe.exec(); // pipeline æ‰§è¡Œ
      pipe.close();
  
      return count.get() <= maxCount; // æ˜¯å¦è¶…è¿‡æœ€å¤§æ¬¡æ•°ã€‚
  }
  ```

  - è¯¥å®ç°ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå¯èƒ½ä¸€ä¸ªæ— æ•ˆçš„æ“ä½œï¼Œä¹Ÿè¢«è®°å½•åˆ°æ¬¡æ•°ä¸­ã€‚å®Œç¾çš„è¯ï¼Œå¯èƒ½éœ€è¦åŸºäº Lua è„šæœ¬å®ç°ã€‚
  - å¦å¤–ï¼Œä¸Šè¿°ä»£ç æ˜¯æ¯ç§’æ“ä½œçš„æ—¶é—´ï¼Œå®é™…éœ€è¦æ”¹æˆæ¯ N ç§’ã€‚æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä¸Šæ‰‹æ€¼å³å¯ã€‚

- ä½¿ç”¨ Lua è„šæœ¬ï¼Œå®ç°ä»¤ç‰Œæ¡¶é™æµç®—æ³•ã€‚å…·ä½“å¯ä»¥çœ‹çœ‹ [ã€ŠSpring-Cloud-Gateway æºç è§£æ â€”â€” è¿‡æ»¤å™¨ (4.10) ä¹‹ RequestRateLimiterGatewayFilterFactory è¯·æ±‚é™æµã€‹](http://www.iocoder.cn/Spring-Cloud-Gateway/filter-request-rate-limiter/?self) çš„æºç è§£æã€‚

- ä½¿ç”¨ Lua è„šæœ¬ï¼Œå®ç°ç®€å•çš„æ»‘åŠ¨çª—å£ã€‚

